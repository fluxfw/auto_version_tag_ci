auto_version_tag_ci:
  stage: deploy
  image: composer:1
  script:
    - php -r 'eval(base64_decode("Ci8qKgogKiBAcGFyYW0gc3RyaW5nICR2YXJpYWJsZQogKgogKiBAcmV0dXJuIHN0cmluZwogKi8KZnVuY3Rpb24gZ2V0RW52aXJvbm1lbnRWYXJpYWJsZShzdHJpbmcgJHZhcmlhYmxlKSA6IHN0cmluZwp7CiAgICAkdmFsdWUgPSBzdHJ2YWwoZmlsdGVyX2lucHV0KElOUFVUX0VOViwgJHZhcmlhYmxlKSk7CgogICAgaWYgKGVtcHR5KCR2YWx1ZSkpIHsKICAgICAgICBlY2hvICJFbnZpcm9ubWVudCB2YXJpYWJsZSAiIC4gJHZhcmlhYmxlIC4gIiBub3Qgc2V0IVxuIjsKICAgICAgICBkaWUoMSk7CiAgICB9CgogICAgcmV0dXJuICR2YWx1ZTsKfQoKLyoqCiAqIEBwYXJhbSBzdHJpbmcgJGFwaV91cmwKICogQHBhcmFtIGludCAgICAkZXhwZWN0X3N0YXR1c19jb2RlCiAqIEBwYXJhbSBib29sICAgJHBvc3QKICoKICogQHJldHVybiBzdHJpbmd8bnVsbAogKi8KZnVuY3Rpb24gZ2l0bGFiUmVxdWVzdChzdHJpbmcgJGFwaV91cmwsIGludCAkZXhwZWN0X3N0YXR1c19jb2RlLCBib29sICRwb3N0ID0gZmFsc2UpLyogOiA/c3RyaW5nKi8KewogICAgJEFVVE9fVkVSU0lPTl9UQUdfVE9LRU4gPSBnZXRFbnZpcm9ubWVudFZhcmlhYmxlKCJBVVRPX1ZFUlNJT05fVEFHX1RPS0VOIik7CiAgICAkU0VSVkVSX1VSTCA9IGdldEVudmlyb25tZW50VmFyaWFibGUoIkNJX1NFUlZFUl9VUkwiKTsKICAgICRQUk9KRUNUX0lEID0gZ2V0RW52aXJvbm1lbnRWYXJpYWJsZSgiQ0lfUFJPSkVDVF9JRCIpOwoKICAgICRjdXJsID0gbnVsbDsKICAgICRyZXNwb25zZSA9IG51bGw7CiAgICAkc3RhdHVzX2NvZGUgPSBudWxsOwogICAgdHJ5IHsKICAgICAgICAkcmVxdWVzdF91cmwgPSAkU0VSVkVSX1VSTCAuICIvYXBpL3Y0L3Byb2plY3RzLyIgLiAkUFJPSkVDVF9JRCAuICIvIiAuICRhcGlfdXJsOwogICAgICAgIGVjaG8gIlJlcXVlc3QgdXJsOiAiIC4gJHJlcXVlc3RfdXJsIC4gIlxuIjsKCiAgICAgICAgJGN1cmwgPSBjdXJsX2luaXQoJHJlcXVlc3RfdXJsKTsKICAgICAgICBjdXJsX3NldG9wdCgkY3VybCwgQ1VSTE9QVF9IVFRQSEVBREVSLCBbIlBSSVZBVEUtVE9LRU46ICIgLiAkQVVUT19WRVJTSU9OX1RBR19UT0tFTl0pOwoKICAgICAgICBpZiAoJHBvc3QpIHsKICAgICAgICAgICAgY3VybF9zZXRvcHQoJGN1cmwsIENVUkxPUFRfUE9TVCwgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICBjdXJsX3NldG9wdCgkY3VybCwgQ1VSTE9QVF9SRVRVUk5UUkFOU0ZFUiwgdHJ1ZSk7CgogICAgICAgICRyZXNwb25zZSA9IGN1cmxfZXhlYygkY3VybCk7CiAgICAgICAgZWNobyAiUmVzcG9uc2U6ICIgLiAkcmVzcG9uc2UgLiAiXG4iOwoKICAgICAgICAkc3RhdHVzX2NvZGUgPSBpbnR2YWwoY3VybF9nZXRpbmZvKCRjdXJsLCBDVVJMSU5GT19IVFRQX0NPREUpKTsKICAgICAgICBlY2hvICJTdGF0dXMgY29kZTogIiAuICRzdGF0dXNfY29kZSAuICJcbiI7CiAgICB9IGZpbmFsbHkgewogICAgICAgIGlmICgkY3VybCAhPT0gbnVsbCkgewogICAgICAgICAgICBjdXJsX2Nsb3NlKCRjdXJsKTsKICAgICAgICB9CiAgICB9CiAgICBpZiAoJHN0YXR1c19jb2RlICE9PSAkZXhwZWN0X3N0YXR1c19jb2RlKSB7CiAgICAgICAgZWNobyAiRXhwZWN0IHN0YXR1cyBjb2RlOiAiIC4gJGV4cGVjdF9zdGF0dXNfY29kZSAuICJcbiI7CiAgICAgICAgZGllKDEpOwogICAgfQoKICAgIHJldHVybiAkcmVzcG9uc2U7Cn0KCmlmIChwaHBfc2FwaV9uYW1lKCkgIT09ICJjbGkiKSB7CiAgICBkaWUoKTsKfQoKJENPTU1JVF9JRCA9IGdldEVudmlyb25tZW50VmFyaWFibGUoIkNJX0NPTU1JVF9TSEEiKTsKCiRjb21wb3Nlcl9qc29uID0ganNvbl9kZWNvZGUoZmlsZV9nZXRfY29udGVudHMoZ2V0Y3dkKCkgLiAiL2NvbXBvc2VyLmpzb24iKSk7CiR2ZXJzaW9uID0gJGNvbXBvc2VyX2pzb24tPnZlcnNpb247CgokY2hhbmdlbG9nX21kID0gZmlsZV9nZXRfY29udGVudHMoZ2V0Y3dkKCkgLiAiL0NIQU5HRUxPRy5tZCIpOwokY2hhbmdlbG9nX2hlYWRlciA9ICIjIyBbIiAuICR2ZXJzaW9uIC4gIl0iOwokY2hhbmdlbG9nX2hlYWRlcl9wb3MgPSBzdHJwb3MoJGNoYW5nZWxvZ19tZCwgJGNoYW5nZWxvZ19oZWFkZXIpOwppZiAoJGNoYW5nZWxvZ19oZWFkZXJfcG9zID09PSBmYWxzZSkgewogICAgZWNobyAiQ2hhbmdlbG9nIGZvciAiIC4gJHZlcnNpb24gLiAiIG5vdCBmb3VuZCFcbiI7CiAgICBkaWUoMSk7Cn0KJGNoYW5nZWxvZyA9IHN1YnN0cigkY2hhbmdlbG9nX21kLCAkY2hhbmdlbG9nX2hlYWRlcl9wb3MgKyBzdHJsZW4oJGNoYW5nZWxvZ19oZWFkZXIpKTsKJGNoYW5nZWxvZyA9IHN1YnN0cigkY2hhbmdlbG9nLCAwLCBzdHJwb3MoJGNoYW5nZWxvZywgIlxuXG4iKSk7CiRjaGFuZ2Vsb2cgPSB0cmltKCRjaGFuZ2Vsb2cpOwoKJG1haW50YWluZXJfdXNlcl9pZCA9IGdpdGxhYlJlcXVlc3QoIm1lbWJlcnMiLCAyMDApOwppZiAoZW1wdHkoJG1haW50YWluZXJfdXNlcl9pZCkgfHwgZW1wdHkoJG1haW50YWluZXJfdXNlcl9pZCA9IGpzb25fZGVjb2RlKCRtYWludGFpbmVyX3VzZXJfaWQsIHRydWUpKSB8fCAhaXNfYXJyYXkoJG1haW50YWluZXJfdXNlcl9pZCkpIHsKICAgIGVjaG8gIk5vIHByb2plY3QgbWVtYmVycyBmb3VuZCFcbiI7CiAgICBkaWUoMSk7Cn0KJG1haW50YWluZXJfdXNlcl9pZCA9IGFycmF5X2ZpbHRlcigkbWFpbnRhaW5lcl91c2VyX2lkLCBmdW5jdGlvbiAoYXJyYXkgJG1lbWJlcikgOiBib29sIHsKICAgIHJldHVybiAoJG1lbWJlclsiYWNjZXNzX2xldmVsIl0gPT09IDQwKTsKfSk7CmlmIChlbXB0eSgkbWFpbnRhaW5lcl91c2VyX2lkKSkgewogICAgZWNobyAiTm8gcHJvamVjdCBtYWludGFpbmVyIGZvdW5kIVxuIjsKICAgIGRpZSgxKTsKfQokbWFpbnRhaW5lcl91c2VyX2lkID0gY3VycmVudCgkbWFpbnRhaW5lcl91c2VyX2lkKVsiaWQiXTsKCmdpdGxhYlJlcXVlc3QoInJlcG9zaXRvcnkvdGFncz90YWdfbmFtZT0iIC4gcmF3dXJsZW5jb2RlKCJ2IiAuICR2ZXJzaW9uKSAuICImcmVmPSIgLiByYXd1cmxlbmNvZGUoJENPTU1JVF9JRCkgLiAiJm1lc3NhZ2U9IiAuIHJhd3VybGVuY29kZSgkY2hhbmdlbG9nKSAuICImcmVsZWFzZV9kZXNjcmlwdGlvbj0iCiAgICAuIHJhd3VybGVuY29kZSgkY2hhbmdlbG9nKSwgMjAxLCB0cnVlKTsKCmdpdGxhYlJlcXVlc3QoIm1lcmdlX3JlcXVlc3RzP3NvdXJjZV9icmFuY2g9IiAuIHJhd3VybGVuY29kZSgiZGV2ZWxvcCIpIC4gIiZ0YXJnZXRfYnJhbmNoPSIgLiByYXd1cmxlbmNvZGUoIm1hc3RlciIpIC4gIiZ0aXRsZT0iIC4gcmF3dXJsZW5jb2RlKCJXSVA6IERldmVsb3AiKSAuICImYXNzaWduZWVfaWQ9IgogICAgLiByYXd1cmxlbmNvZGUoJG1haW50YWluZXJfdXNlcl9pZCksIDIwMSwgdHJ1ZSk7"));'
  only:
    - /^master$/
